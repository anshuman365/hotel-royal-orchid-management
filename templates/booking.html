{% extends "base.html" %}

{% block title %}Book {{ room.name }} - Hotel Royal Orchid{% endblock %}

{% block extra_css %}
<style>
    .booking-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        position: relative;
    }
    .booking-steps::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #e5e7eb;
        z-index: 1;
    }
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
    }
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .step.active .step-number {
        background: #d97706;
        color: white;
    }
    .step.completed .step-number {
        background: #059669;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="bg-gray-900 py-16">
    <div class="max-w-7xl mx-auto px-4">
        <div class="text-white">
            <nav class="flex items-center space-x-2 text-sm mb-6">
                <a href="{{ url_for('main.index') }}" class="hover:text-amber-400">Home</a>
                <span class="text-gray-400">/</span>
                <a href="{{ url_for('main.rooms') }}" class="hover:text-amber-400">Rooms</a>
                <span class="text-gray-400">/</span>
                <a href="{{ url_for('main.room_detail', room_id=room.id) }}" class="hover:text-amber-400">{{ room.name }}</a>
                <span class="text-gray-400">/</span>
                <span class="text-amber-400">Booking</span>
            </nav>
            
            <h1 class="text-4xl font-serif font-bold mb-4" data-aos="fade-up">Complete Your Booking</h1>
            <p class="text-xl text-gray-300" data-aos="fade-up" data-aos-delay="200">You're just a few steps away from your luxury stay</p>
        </div>
    </div>
</section>

<!-- Booking Steps -->
<section class="bg-white py-8 border-b">
    <div class="max-w-4xl mx-auto px-4">
        <div class="booking-steps">
            <div class="step active">
                <div class="step-number">1</div>
                <span class="text-sm font-medium text-amber-600">Booking Details</span>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <span class="text-sm font-medium text-gray-500">Payment</span>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <span class="text-sm font-medium text-gray-500">Confirmation</span>
            </div>
        </div>
    </div>
</section>

<!-- Booking Form -->
<section class="py-16 bg-gray-50">
    <div class="max-w-6xl mx-auto px-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Booking Summary -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-6 mb-6" data-aos="fade-right">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Booking Information</h2>
                    
                    <form method="POST" action="{{ url_for('booking.book_room', room_id=room.id) }}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Check-in Date *</label>
                                <input type="date" name="check_in" value="{{ check_in }}" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Check-out Date *</label>
                                <input type="date" name="check_out" value="{{ check_out }}" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Adults *</label>
                                <select name="adults" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                                    {% for i in range(1, room.max_adults + 1) %}
                                    <option value="{{ i }}" {% if i == adults %}selected{% endif %}>{{ i }} Adult{% if i > 1 %}s{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Children</label>
                                <select name="children" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                                    {% for i in range(0, room.max_children + 1) %}
                                    <option value="{{ i }}" {% if i == children %}selected{% endif %}>{{ i }} Child{% if i > 1 %}ren{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Special Requests</label>
                            <textarea name="special_requests" rows="4" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent" 
                                      placeholder="Any special requests or requirements..."></textarea>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Coupon Code (Optional)</label>
                            <div class="flex gap-4">
                                <input type="text" name="coupon_code" 
                                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent" 
                                       placeholder="Enter coupon code">
                                <button type="button" id="apply-coupon" 
                                        class="px-6 py-3 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition duration-300">
                                    Apply
                                </button>
                            </div>
                            <div id="coupon-message" class="mt-2 text-sm"></div>
                        </div>

                        <div class="flex space-x-4">
                            <a href="{{ url_for('main.room_detail', room_id=room.id) }}" 
                               class="flex-1 bg-gray-300 text-gray-700 text-center py-4 rounded-lg hover:bg-gray-400 transition duration-300 font-semibold">
                                Back to Room
                            </a>
                            <button type="submit" 
                                    class="flex-1 bg-amber-600 text-white py-4 rounded-lg hover:bg-amber-700 transition duration-300 font-semibold">
                                Continue to Payment
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Price Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24" data-aos="fade-left">
                    <h3 class="text-xl font-semibold text-gray-800 mb-6">Booking Summary</h3>
                    
                    <div class="flex items-center mb-6">
                        <img src="{{ url_for('static', filename='images/rooms/room-' + room.id|string + '.jpg') }}" 
                             alt="{{ room.name }}" class="w-20 h-20 object-cover rounded-lg mr-4">
                        <div>
                            <h4 class="font-semibold text-gray-800">{{ room.name }}</h4>
                            <p class="text-sm text-gray-600">{{ room.room_type }}</p>
                        </div>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Check-in</span>
                            <span class="font-medium">{{ check_in }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Check-out</span>
                            <span class="font-medium">{{ check_out }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Duration</span>
                            <span class="font-medium">{{ nights }} night{% if nights > 1 %}s{% endif %}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Guests</span>
                            <span class="font-medium">{{ adults }} adult{% if adults > 1 %}s{% endif %}{% if children > 0 %}, {{ children }} child{% if children > 1 %}ren{% endif %}{% endif %}</span>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Room Price ({{ nights }} night{% if nights > 1 %}s{% endif %})</span>
                            <span class="font-medium">₹{{ "%.2f"|format(base_amount) }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Taxes & Fees (18%)</span>
                            <span class="font-medium">₹{{ "%.2f"|format(tax_amount) }}</span>
                        </div>
                        <div class="flex justify-between text-amber-600" id="discount-row" style="display: none;">
                            <span>Discount</span>
                            <span>-₹<span id="discount-amount">0.00</span></span>
                        </div>
                        <div class="flex justify-between text-lg font-semibold text-gray-800 border-t pt-2">
                            <span>Total Amount</span>
                            <span>₹<span id="total-amount">{{ "%.2f"|format(total_amount) }}</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set minimum dates for date inputs
        const today = new Date().toISOString().split('T')[0];
        const checkInInput = document.querySelector('input[name="check_in"]');
        const checkOutInput = document.querySelector('input[name="check_out"]');
        
        checkInInput.min = today;
        
        // Set check-out min based on check-in
        checkInInput.addEventListener('change', function() {
            const checkInDate = new Date(this.value);
            const minCheckOut = new Date(checkInDate);
            minCheckOut.setDate(minCheckOut.getDate() + 1);
            checkOutInput.min = minCheckOut.toISOString().split('T')[0];
            
            // If current check-out is invalid, clear it
            if (checkOutInput.value && new Date(checkOutInput.value) <= checkInDate) {
                checkOutInput.value = '';
            }
        });

        // Coupon application
        document.getElementById('apply-coupon').addEventListener('click', function() {
            const couponCode = document.querySelector('input[name="coupon_code"]').value;
            const totalAmount = {{ total_amount }};
            
            if (!couponCode) {
                showCouponMessage('Please enter a coupon code', 'error');
                return;
            }
            
            fetch('{{ url_for("booking.apply_coupon") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    coupon_code: couponCode,
                    total_amount: totalAmount
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showCouponMessage(data.message, 'success');
                    document.getElementById('discount-amount').textContent = data.discount.toFixed(2);
                    document.getElementById('total-amount').textContent = data.final_amount.toFixed(2);
                    document.getElementById('discount-row').style.display = 'flex';
                } else {
                    showCouponMessage(data.message, 'error');
                }
            })
            .catch(error => {
                showCouponMessage('An error occurred. Please try again.', 'error');
            });
        });
        
        function showCouponMessage(message, type) {
            const messageDiv = document.getElementById('coupon-message');
            messageDiv.textContent = message;
            messageDiv.className = 'mt-2 text-sm ' + (type === 'success' ? 'text-green-600' : 'text-red-600');
        }

        // Form validation
        const form = document.querySelector('form');
        form.addEventListener('submit', function(e) {
            const checkIn = document.querySelector('input[name="check_in"]').value;
            const checkOut = document.querySelector('input[name="check_out"]').value;
            
            if (!checkIn || !checkOut) {
                e.preventDefault();
                alert('Please select both check-in and check-out dates');
                return;
            }
            
            if (new Date(checkOut) <= new Date(checkIn)) {
                e.preventDefault();
                alert('Check-out date must be after check-in date');
                return;
            }
        });
    });
</script>
{% endblock %}