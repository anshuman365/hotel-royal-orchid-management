<!-- templates/admin/admin_chatbot.html -->
{% extends "base.html" %}

{% block title %}Admin AI Assistant | Hotel Royal Orchid Admin{% endblock %}

{% block extra_css %}
<style>
    :root {
        --admin-primary: #1a365d;
        --admin-secondary: #2d3748;
        --admin-accent: #3182ce;
        --admin-success: #38a169;
        --admin-warning: #d69e2e;
        --admin-danger: #e53e3e;
    }
    
    .admin-chatbot-container {
        max-width: 1200px;
        margin: 1rem auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        overflow: hidden;
        height: 90vh;
        display: flex;
        flex-direction: column;
    }
    
    .admin-chat-header {
        background: linear-gradient(135deg, var(--admin-primary), var(--admin-secondary));
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .admin-chat-header h1 {
        font-size: 1.8em;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .admin-badge {
        background: var(--admin-accent);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.7em;
        font-weight: 600;
    }
    
    .admin-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .control-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85em;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .control-btn:hover {
        background: rgba(255,255,255,0.3);
        transform: translateY(-1px);
    }
    
    .admin-chat-layout {
        display: flex;
        flex: 1;
        overflow: hidden;
    }
    
    .business-panel {
        width: 300px;
        background: #f8fafc;
        border-right: 1px solid #e2e8f0;
        overflow-y: auto;
        padding: 20px;
    }
    
    .panel-section {
        margin-bottom: 25px;
    }
    
    .panel-section h3 {
        font-size: 0.9em;
        color: var(--admin-secondary);
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e2e8f0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .metric-item {
        background: white;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        border-left: 4px solid var(--admin-accent);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .metric-value {
        font-size: 1.2em;
        font-weight: bold;
        color: var(--admin-primary);
    }
    
    .metric-label {
        font-size: 0.8em;
        color: #718096;
        margin-top: 4px;
    }
    
    .alert-item {
        background: #fff5f5;
        border-left-color: var(--admin-danger);
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 6px;
        font-size: 0.85em;
    }
    
    .success-item {
        background: #f0fff4;
        border-left-color: var(--admin-success);
    }
    
    .warning-item {
        background: #fffaf0;
        border-left-color: var(--admin-warning);
    }
    
    .quick-action {
        background: white;
        border: 1px solid #e2e8f0;
        padding: 10px 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.85em;
    }
    
    .quick-action:hover {
        background: var(--admin-accent);
        color: white;
        transform: translateX(5px);
    }
    
    .admin-chat-messages {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f7fafc;
    }
    
    .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    .admin-message {
        margin-bottom: 20px;
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }
    
    .admin-message.user {
        justify-content: flex-end;
    }
    
    .admin-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9em;
        flex-shrink: 0;
    }
    
    .user .admin-avatar {
        background: var(--admin-accent);
        color: white;
    }
    
    .assistant .admin-avatar {
        background: var(--admin-primary);
        color: white;
    }
    
    .admin-message-content {
        max-width: 70%;
        padding: 16px 20px;
        border-radius: 18px;
        position: relative;
        animation: fadeInUp 0.4s ease-out;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .user .admin-message-content {
        background: var(--admin-accent);
        color: white;
        border-bottom-right-radius: 4px;
    }
    
    .assistant .admin-message-content {
        background: white;
        color: var(--admin-secondary);
        border-bottom-left-radius: 4px;
        border: 1px solid #e2e8f0;
    }
    
    .message-time {
        font-size: 0.7em;
        color: #a0aec0;
        margin-top: 5px;
        text-align: right;
    }
    
    .assistant .message-time {
        text-align: left;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0;
        font-size: 0.85em;
    }
    
    .data-table th {
        background: #f1f5f9;
        padding: 8px 12px;
        text-align: left;
        font-weight: 600;
        color: var(--admin-secondary);
        border-bottom: 2px solid #e2e8f0;
    }
    
    .data-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .data-table tr:hover {
        background: #f7fafc;
    }
    
    .insight-highlight {
        background: linear-gradient(120deg, #fed7e2 0%, #fed7e2 100%);
        padding: 12px 16px;
        border-radius: 8px;
        margin: 10px 0;
        border-left: 4px solid #ed64a6;
    }
    
    .admin-chat-input-container {
        padding: 20px;
        border-top: 1px solid #e2e8f0;
        background: white;
    }
    
    .admin-chat-input-form {
        display: flex;
        gap: 12px;
        align-items: flex-end;
    }
    
    .admin-chat-input {
        flex: 1;
        padding: 14px 18px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        outline: none;
        font-size: 1em;
        transition: border-color 0.3s ease;
        resize: none;
        min-height: 60px;
        max-height: 120px;
        font-family: inherit;
    }
    
    .admin-chat-input:focus {
        border-color: var(--admin-accent);
    }
    
    .admin-send-button {
        background: var(--admin-accent);
        color: white;
        border: none;
        padding: 14px 20px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .admin-send-button:hover {
        background: var(--admin-primary);
        transform: translateY(-2px);
    }
    
    .admin-send-button:disabled {
        background: #cbd5e0;
        cursor: not-allowed;
        transform: none;
    }
    
    .quick-questions-panel {
        background: white;
        padding: 15px 20px;
        border-top: 1px solid #e2e8f0;
    }
    
    .quick-questions-panel h4 {
        margin-bottom: 12px;
        color: var(--admin-secondary);
        font-size: 0.9em;
    }
    
    .question-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .admin-question-chip {
        background: #edf2f7;
        color: var(--admin-secondary);
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e2e8f0;
    }
    
    .admin-question-chip:hover {
        background: var(--admin-accent);
        color: white;
        transform: translateY(-1px);
    }
    
    .typing-indicator {
        display: none;
        padding: 16px 20px;
        background: white;
        border-radius: 18px;
        border-bottom-left-radius: 4px;
        max-width: 70%;
        border: 1px solid #e2e8f0;
        margin-bottom: 20px;
    }
    
    .typing-dots {
        display: flex;
        gap: 4px;
    }
    
    .typing-dot {
        width: 8px;
        height: 8px;
        background: #a0aec0;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
    
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .report-section {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 15px;
        margin: 10px 0;
    }
    
    .report-section h5 {
        color: var(--admin-primary);
        margin-bottom: 10px;
        font-size: 0.9em;
    }
    
    @media (max-width: 768px) {
        .admin-chat-layout {
            flex-direction: column;
        }
        
        .business-panel {
            width: 100%;
            max-height: 200px;
        }
        
        .admin-message-content {
            max-width: 85%;
        }
        
        .admin-chat-header {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }
        
        .admin-controls {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-chatbot-container">
    <!-- Header -->
    <div class="admin-chat-header">
        <div>
            <h1>
                <i class="fas fa-robot"></i>
                ROY Admin Assistant
                <span class="admin-badge">BUSINESS INTELLIGENCE</span>
            </h1>
            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">
                Real-time business data & strategic insights for {{ current_user.name }}
            </p>
        </div>
        <div class="admin-controls">
            <button class="control-btn" onclick="generateBusinessReport()">
                <i class="fas fa-file-alt"></i>Generate Report
            </button>
            <button class="control-btn" onclick="clearAdminChat()">
                <i class="fas fa-broom"></i>Clear Chat
            </button>
            <button class="control-btn" onclick="exportChat()">
                <i class="fas fa-download"></i>Export
            </button>
        </div>
    </div>

    <div class="admin-chat-layout">
        <!-- Business Data Panel -->
        <div class="business-panel">
            <div class="panel-section">
                <h3><i class="fas fa-chart-line"></i> Live Metrics</h3>
                <div class="metric-item">
                    <div class="metric-value" id="occupancyMetric">Loading...</div>
                    <div class="metric-label">Current Occupancy</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="revenueMetric">Loading...</div>
                    <div class="metric-label">Today's Revenue</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="bookingsMetric">Loading...</div>
                    <div class="metric-label">Today's Bookings</div>
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-bell"></i> Alerts</h3>
                <div id="alertsContainer">
                    <div class="success-item">Loading alerts...</div>
                </div>
            </div>

            <div class="panel-section">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                <div class="quick-action" onclick="askQuestion('Show me today\\'s performance summary')">
                    <i class="fas fa-chart-pie"></i> Today's Summary
                </div>
                <div class="quick-action" onclick="askQuestion('Analyze revenue trends for the last 30 days')">
                    <i class="fas fa-money-bill-wave"></i> Revenue Analysis
                </div>
                <div class="quick-action" onclick="askQuestion('What are the current operational issues?')">
                    <i class="fas fa-exclamation-triangle"></i> Operational Issues
                </div>
                <div class="quick-action" onclick="askQuestion('Provide customer satisfaction insights')">
                    <i class="fas fa-smile"></i> Customer Insights
                </div>
                <div class="quick-action" onclick="askQuestion('Suggest improvements for hotel operations')">
                    <i class="fas fa-lightbulb"></i> Improvement Ideas
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="admin-chat-messages">
            <div class="messages-container" id="adminMessagesContainer">
                <div class="admin-message assistant">
                    <div class="admin-avatar">AI</div>
                    <div class="admin-message-content">
                        <strong>ROY Admin Assistant</strong><br><br>
                        Welcome to your business intelligence dashboard, <strong>{{ current_user.name }}</strong>! ðŸ¤–<br><br>
                        
                        I have access to <strong>real-time business data</strong> including:
                        â€¢ Live occupancy and revenue metrics<br>
                        â€¢ Customer behavior patterns<br>
                        â€¢ Room performance analytics<br>
                        â€¢ Financial reports<br>
                        â€¢ Operational alerts<br><br>
                        
                        <div class="insight-highlight">
                            <strong>ðŸ’¡ Pro Tip:</strong> Ask me specific questions like:<br>
                            â€¢ "What's our current occupancy rate?"<br>
                            â€¢ "Show me revenue trends for this month"<br>
                            â€¢ "Analyze customer satisfaction scores"<br>
                            â€¢ "What are the top performing rooms?"<br>
                        </div>
                        
                        How can I assist with your business analysis today?
                        <div class="message-time" id="welcomeTime"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Questions -->
            <div class="quick-questions-panel">
                <h4><i class="fas fa-rocket"></i> Quick Analysis Requests:</h4>
                <div class="question-chips">
                    <div class="admin-question-chip" onclick="askQuestion('Show current business overview')">Business Overview</div>
                    <div class="admin-question-chip" onclick="askQuestion('Analyze today\\'s performance')">Today's Performance</div>
                    <div class="admin-question-chip" onclick="askQuestion('What are the urgent alerts?')">Urgent Alerts</div>
                    <div class="admin-question-chip" onclick="askQuestion('Revenue breakdown by room type')">Revenue Analysis</div>
                    <div class="admin-question-chip" onclick="askQuestion('Customer satisfaction report')">Customer Report</div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="admin-chat-input-container">
                <form class="admin-chat-input-form" id="adminChatForm">
                    <textarea class="admin-chat-input" id="adminMessageInput" 
                             placeholder="Ask about business performance, analytics, or request specific reports... (Shift+Enter for new line)" 
                             rows="1"></textarea>
                    <button type="submit" class="admin-send-button" id="adminSendButton">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Typing Indicator -->
    <div class="typing-indicator" id="adminTypingIndicator">
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    class AdminChatbot {
        constructor() {
            this.messagesContainer = document.getElementById('adminMessagesContainer');
            this.messageInput = document.getElementById('adminMessageInput');
            this.chatForm = document.getElementById('adminChatForm');
            this.sendButton = document.getElementById('adminSendButton');
            this.typingIndicator = document.getElementById('adminTypingIndicator');
            
            this.init();
        }
        
        init() {
            this.setWelcomeTime();
            this.loadAdminChatHistory();
            this.loadLiveMetrics();
            this.setupEventListeners();
            this.setupMetricsRefresh();
        }
        
        setWelcomeTime() {
            document.getElementById('welcomeTime').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        setupEventListeners() {
            this.chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                this.sendAdminMessage();
            });
            
            this.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendAdminMessage();
                }
                
                // Auto-resize textarea
                this.messageInput.style.height = 'auto';
                this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
            });
            
            this.messageInput.addEventListener('input', () => {
                this.messageInput.style.height = 'auto';
                this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
            });
        }
        
        async loadAdminChatHistory() {
            try {
                const response = await fetch('/api/admin/chat/history');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.history.length > 0) {
                    // Clear welcome message if we have history
                    this.messagesContainer.innerHTML = '';
                    data.history.forEach(msg => {
                        this.addMessage(msg.content, msg.role);
                    });
                }
            } catch (error) {
                console.error('Failed to load admin chat history:', error);
                // Don't show error for history - it's non-critical
            }
        }
        
        async loadLiveMetrics() {
            try {
                const response = await fetch('/api/admin/metrics/live');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('occupancyMetric').textContent = data.occupancy + '%';
                    document.getElementById('revenueMetric').textContent = 'â‚¹' + data.revenue.toLocaleString();
                    document.getElementById('bookingsMetric').textContent = data.bookings;
                    
                    // Update alerts
                    this.updateAlerts(data.alerts);
                } else {
                    this.showMetricError();
                }
            } catch (error) {
                console.error('Failed to load live metrics:', error);
                this.showMetricError();
            }
        }

        showMetricError() {
            document.getElementById('occupancyMetric').textContent = 'Error';
            document.getElementById('revenueMetric').textContent = 'Error';
            document.getElementById('bookingsMetric').textContent = 'Error';
            
            const container = document.getElementById('alertsContainer');
            container.innerHTML = '<div class="alert-item">Unable to load metrics</div>';
        }
        
        updateAlerts(alerts) {
            const container = document.getElementById('alertsContainer');
            container.innerHTML = '';
            
            if (alerts.length === 0) {
                container.innerHTML = '<div class="success-item">No critical alerts</div>';
                return;
            }
            
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert-item ${alert.type === 'warning' ? 'warning-item' : 'alert-item'}`;
                alertDiv.innerHTML = `
                    <strong>${alert.title}</strong><br>
                    <small>${alert.message}</small>
                `;
                container.appendChild(alertDiv);
            });
        }
        
        setupMetricsRefresh() {
            // Refresh metrics every 30 seconds
            setInterval(() => {
                this.loadLiveMetrics();
            }, 30000);
        }
        
        async sendAdminMessage() {
            const message = this.messageInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            this.addMessage(message, 'user');
            this.messageInput.value = '';
            this.sendButton.disabled = true;
            
            // Reset textarea height
            this.messageInput.style.height = 'auto';
            
            // Show typing indicator
            this.showTypingIndicator();
            
            try {
                const response = await fetch('/api/admin/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ message: message })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Hide typing indicator
                this.hideTypingIndicator();
                
                if (data.success) {
                    this.addMessage(data.response, 'assistant', data.timestamp);
                } else {
                    this.addMessage('Sorry, I encountered an error processing your request. Please try again.', 'assistant');
                }
            } catch (error) {
                this.hideTypingIndicator();
                this.addMessage('Sorry, I\'m having trouble connecting to the business data service. Please check your connection.', 'assistant');
                console.error('Admin chat error:', error);
            }
            
            this.sendButton.disabled = false;
            this.messageInput.focus();
        }
        
        addMessage(content, role, timestamp = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `admin-message ${role}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'admin-avatar';
            avatar.textContent = role === 'user' ? '{{ current_user.name[0]|upper }}' : 'AI';
            
            const messageContent = document.createElement('div');
            messageContent.className = 'admin-message-content';
            
            // Parse and format the content (handle tables, etc.)
            messageContent.innerHTML = this.formatMessageContent(content);
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = timestamp ? new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            messageContent.appendChild(timeDiv);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            this.messagesContainer.appendChild(messageDiv);
            this.scrollToBottom();
        }
        
        formatMessageContent(content) {
            // Simple formatting for tables and structured data
            let formattedContent = content;
            
            // Convert markdown-style tables to HTML tables
            if (content.includes('|') && content.includes('-')) {
                const lines = content.split('\n');
                let inTable = false;
                let tableHtml = '';
                
                lines.forEach(line => {
                    if (line.includes('|') && line.trim().startsWith('|')) {
                        if (!inTable) {
                            inTable = true;
                            tableHtml = '<div class="report-section"><table class="data-table">';
                        }
                        
                        const cells = line.split('|').filter(cell => cell.trim() !== '');
                        if (cells.length > 0) {
                            tableHtml += '<tr>';
                            cells.forEach(cell => {
                                if (line.includes('---')) {
                                    tableHtml += `<th>${cell.trim()}</th>`;
                                } else {
                                    tableHtml += `<td>${cell.trim()}</td>`;
                                }
                            });
                            tableHtml += '</tr>';
                        }
                    } else if (inTable) {
                        inTable = false;
                        tableHtml += '</table></div>';
                        formattedContent = formattedContent.replace(line, tableHtml);
                    }
                });
            }
            
            // Highlight important insights
            formattedContent = formattedContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formattedContent = formattedContent.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Convert line breaks to <br>
            formattedContent = formattedContent.replace(/\n/g, '<br>');
            
            return formattedContent;
        }
        
        showTypingIndicator() {
            this.typingIndicator.style.display = 'block';
            this.scrollToBottom();
        }
        
        hideTypingIndicator() {
            this.typingIndicator.style.display = 'none';
        }
        
        scrollToBottom() {
            this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
        }
        
        async clearAdminChat() {
            if (confirm('Are you sure you want to clear the admin chat history?')) {
                try {
                    const response = await fetch('/api/admin/chat/clear', { 
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to clear chat');
                    }
                    
                    this.messagesContainer.innerHTML = `
                        <div class="admin-message assistant">
                            <div class="admin-avatar">AI</div>
                            <div class="admin-message-content">
                                <strong>ROY Admin Assistant</strong><br><br>
                                Chat history cleared. How can I assist with your business analysis today?
                                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error('Failed to clear admin chat:', error);
                    alert('Failed to clear chat history. Please try again.');
                }
            }
        }
    }
    
    // Global functions for quick actions
    function askQuestion(question) {
        const chatbot = window.adminChatbot;
        chatbot.messageInput.value = question;
        chatbot.sendAdminMessage();
    }
    
    async function generateBusinessReport() {
        const chatbot = window.adminChatbot;
        chatbot.showTypingIndicator();
        
        try {
            const response = await fetch('/api/admin/chat/generate-report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    report_type: 'comprehensive'
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            chatbot.hideTypingIndicator();
            
            if (data.success) {
                chatbot.addMessage(data.report, 'assistant', data.generated_at);
            } else {
                chatbot.addMessage('Failed to generate business report. Please try again.', 'assistant');
            }
        } catch (error) {
            chatbot.hideTypingIndicator();
            chatbot.addMessage('Error generating business report. Please check your connection.', 'assistant');
            console.error('Report generation error:', error);
        }
    }
    
    function exportChat() {
        // Simple export functionality - in production, this would generate a proper file
        const chatContent = document.getElementById('adminMessagesContainer').innerText;
        const blob = new Blob([chatContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `admin-chat-export-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function clearAdminChat() {
        if (window.adminChatbot) {
            window.adminChatbot.clearAdminChat();
        }
    }
    
    // Initialize chatbot when page loads
    document.addEventListener('DOMContentLoaded', () => {
        window.adminChatbot = new AdminChatbot();
    });
</script>
{% endblock %}