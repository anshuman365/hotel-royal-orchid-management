{% extends "base.html" %}

{% block title %}Manage Reviews - Hotel Royal Orchid{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<!-- Header -->
<div class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Manage Reviews</h1>
                <p class="text-gray-600">Approve, reject, and respond to guest reviews</p>
            </div>
            <div class="flex items-center space-x-4">
                <span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm font-medium">
                    {{ reviews|length }} review{% if reviews|length != 1 %}s{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="bg-gray-50 border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
            <div class="flex space-x-4">
                <select id="status-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending Approval</option>
                    <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Reviews</option>
                </select>
                
                <select id="room-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent">
                    <option value="">All Rooms</option>
                    {% for room in rooms %}
                    <option value="{{ room.id }}" {% if room_filter == room.id %}selected{% endif %}>{{ room.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="text-sm text-gray-600">
                <div id="review-stats" class="flex space-x-4">
                    <!-- Stats will be loaded via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reviews List -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {% if reviews %}
    <div class="space-y-6">
        {% for review in reviews %}
        <div class="bg-white rounded-2xl shadow-lg p-6 {% if not review.is_approved %}border-l-4 border-amber-500{% endif %}">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between">
                <!-- Review Content -->
                <div class="flex-1">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                                <span class="text-amber-600 font-semibold">{{ review.user_avatar }}</span>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">{{ review.user.name }}</h3>
                                <div class="flex items-center space-x-2">
                                    <div class="flex text-amber-400">
                                        {% for i in range(5) %}
                                        <span>{% if i < review.rating %}‚òÖ{% else %}‚òÜ{% endif %}</span>
                                        {% endfor %}
                                    </div>
                                    <span class="text-gray-500 text-sm">{{ review.created_at.strftime('%B %d, %Y') }}</span>
                                    {% if review.is_verified %}
                                    <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">‚úì Verified Stay</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if review.is_approved %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {% if review.is_approved %}Approved{% else %}Pending{% endif %}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Room Info -->
                    <div class="mb-4">
                        <span class="text-sm text-gray-600">Room: </span>
                        <a href="{{ url_for('main.room_detail', room_id=review.room.id) }}" class="text-amber-600 hover:text-amber-700 font-medium">
                            {{ review.room.name }}
                        </a>
                    </div>
                    
                    <!-- Detailed Ratings -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-4 text-sm">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Cleanliness:</span>
                            <span class="font-medium">{{ review.cleanliness_rating }}/5</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Comfort:</span>
                            <span class="font-medium">{{ review.comfort_rating }}/5</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Location:</span>
                            <span class="font-medium">{{ review.location_rating }}/5</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Amenities:</span>
                            <span class="font-medium">{{ review.amenities_rating }}/5</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Service:</span>
                            <span class="font-medium">{{ review.service_rating }}/5</span>
                        </div>
                    </div>
                    
                    <!-- Review Title & Comment -->
                    {% if review.title %}
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">{{ review.title }}</h4>
                    {% endif %}
                    
                    <p class="text-gray-700 mb-4">{{ review.comment }}</p>
                    
                    <!-- Management Reply -->
                    {% if review.reply %}
                    <div class="bg-blue-50 rounded-lg p-4 mt-4">
                        <div class="flex items-center mb-2">
                            <span class="font-semibold text-blue-800">Management Response</span>
                            <span class="text-blue-600 text-sm ml-2">{{ review.reply_date.strftime('%B %d, %Y') }}</span>
                        </div>
                        <p class="text-blue-700">{{ review.reply }}</p>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Action Buttons -->
                <div class="lg:ml-6 mt-4 lg:mt-0 flex lg:flex-col space-x-2 lg:space-x-0 lg:space-y-2">
                    {% if not review.is_approved %}
                    <a href="{{ url_for('admin.approve_review', review_id=review.id) }}" 
                       class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300 text-sm font-medium">
                        Approve
                    </a>
                    
                    <button type="button" onclick="showRejectionModal({{ review.id }})"
                            class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300 text-sm font-medium">
                        Reject
                    </button>
                    {% endif %}
                    
                    {% if not review.reply %}
                    <button type="button" onclick="showReplyModal({{ review.id }})"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 text-sm font-medium">
                        Reply
                    </button>
                    {% endif %}
                    
                    <a href="{{ url_for('reviews.delete_review', review_id=review.id) }}" 
                       class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition duration-300 text-sm font-medium"
                       onclick="return confirm('Are you sure you want to delete this review?')">
                        Delete
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="text-6xl mb-4">üìù</div>
        <h3 class="text-xl font-semibold text-gray-800 mb-2">No Reviews Found</h3>
        <p class="text-gray-600">There are no reviews matching your current filters.</p>
    </div>
    {% endif %}
</div>

<!-- Rejection Modal -->
<div id="rejectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Reject Review</h3>
        <form id="rejectionForm" method="POST">
            <input type="hidden" name="review_id" id="rejectionReviewId">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason</label>
                <textarea name="rejection_reason" rows="4" required
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent"
                          placeholder="Please provide a reason for rejecting this review..."></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="button" onclick="hideRejectionModal()" 
                        class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition duration-300">
                    Cancel
                </button>
                <button type="submit" 
                        class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 transition duration-300">
                    Reject Review
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Reply Modal -->
<div id="replyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Add Management Response</h3>
        <form id="replyForm" method="POST">
            <input type="hidden" name="review_id" id="replyReviewId">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Your Response</label>
                <textarea name="reply" rows="4" required
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-400 focus:border-transparent"
                          placeholder="Write a professional response to this review..."></textarea>
            </div>
            <div class="flex space-x-4">
                <button type="button" onclick="hideReplyModal()" 
                        class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition duration-300">
                    Cancel
                </button>
                <button type="submit" 
                        class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition duration-300">
                    Post Response
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Filter functionality
    document.getElementById('status-filter').addEventListener('change', function() {
        applyFilters();
    });
    
    document.getElementById('room-filter').addEventListener('change', function() {
        applyFilters();
    });
    
    function applyFilters() {
        const status = document.getElementById('status-filter').value;
        const roomId = document.getElementById('room-filter').value;
        
        const url = new URL(window.location.href);
        
        if (status) {
            url.searchParams.set('status', status);
        } else {
            url.searchParams.delete('status');
        }
        
        if (roomId) {
            url.searchParams.set('room_id', roomId);
        } else {
            url.searchParams.delete('room_id');
        }
        
        window.location.href = url.toString();
    }
    
    // Modal functions
    function showRejectionModal(reviewId) {
        document.getElementById('rejectionReviewId').value = reviewId;
        // dynamically add review_id to the URL
        document.getElementById('rejectionForm').action = `/admin/reject_review/${reviewId}`;
        document.getElementById('rejectionModal').classList.remove('hidden');
    }
    
    function hideRejectionModal() {
        document.getElementById('rejectionModal').classList.add('hidden');
    }
    
    function showReplyModal(reviewId) {
        document.getElementById('replyReviewId').value = reviewId;
        document.getElementById('replyForm').action = `/admin/reply_review/${reviewId}`;
        document.getElementById('replyModal').classList.remove('hidden');
    }
    
    function hideReplyModal() {
        document.getElementById('replyModal').classList.add('hidden');
    }
    
    // Close modals when clicking outside
    document.getElementById('rejectionModal').addEventListener('click', function(e) {
        if (e.target === this) hideRejectionModal();
    });
    
    document.getElementById('replyModal').addEventListener('click', function(e) {
        if (e.target === this) hideReplyModal();
    });
    
    // Load review stats
    document.addEventListener('DOMContentLoaded', function() {
        fetch("{{ url_for('admin.review_stats') }}")
            .then(response => response.json())
            .then(data => {
                const statsContainer = document.getElementById('review-stats');
                statsContainer.innerHTML = `
                    <div>Total: ${data.total_reviews}</div>
                    <div>Pending: ${data.pending_reviews}</div>
                    <div>Approved: ${data.approved_reviews}</div>
                    <div>Avg Rating: ${data.average_rating}/5</div>
                `;
            });
    });
</script>
{% endblock %}